<template>
  <div>
    <!-- Main Banner START -->
    <section class="bg-light">
      <div class="container pt-5 mt-0 mt-lg-5">

        <!-- Title and SVG START -->
        <div class="row position-relative mb-0 mb-sm-5 pb-0 pb-lg-5">
          <div class="col-lg-8 text-center mx-auto position-relative">

            <!-- SVG decoration -->
            <figure class="position-absolute top-100 start-50 translate-middle mt-4 ms-n9 pe-5 d-none d-lg-block">
              <svg>
                <path class="fill-success"
                  d="m181.6 6.7c-0.1 0-0.2-0.1-0.3 0-2.5-0.3-4.9-1-7.3-1.4-2.7-0.4-5.5-0.7-8.2-0.8-1.4-0.1-2.8-0.1-4.1-0.1-0.5 0-0.9-0.1-1.4-0.2-0.9-0.3-1.9-0.1-2.8-0.1-5.4 0.2-10.8 0.6-16.1 1.4-2.7 0.3-5.3 0.8-7.9 1.3-0.6 0.1-1.1 0.3-1.8 0.3-0.4 0-0.7-0.1-1.1-0.1-1.5 0-3 0.7-4.3 1.2-3 1-6 2.4-8.8 3.9-2.1 1.1-4 2.4-5.9 3.9-1 0.7-1.8 1.5-2.7 2.2-0.5 0.4-1.1 0.5-1.5 0.9s-0.7 0.8-1.1 1.2c-1 1-1.9 2-2.9 2.9-0.4 0.3-0.8 0.5-1.2 0.5-1.3-0.1-2.7-0.4-3.9-0.6-0.7-0.1-1.2 0-1.8 0-3.1 0-6.4-0.1-9.5 0.4-1.7 0.3-3.4 0.5-5.1 0.7-5.3 0.7-10.7 1.4-15.8 3.1-4.6 1.6-8.9 3.8-13.1 6.3-2.1 1.2-4.2 2.5-6.2 3.9-0.9 0.6-1.7 0.9-2.6 1.2s-1.7 1-2.5 1.6c-1.5 1.1-3 2.1-4.6 3.2-1.2 0.9-2.7 1.7-3.9 2.7-1 0.8-2.2 1.5-3.2 2.2-1.1 0.7-2.2 1.5-3.3 2.3-0.8 0.5-1.7 0.9-2.5 1.5-0.9 0.8-1.9 1.5-2.9 2.2 0.1-0.6 0.3-1.2 0.4-1.9 0.3-1.7 0.2-3.6 0-5.3-0.1-0.9-0.3-1.7-0.8-2.4s-1.5-1.1-2.3-0.8c-0.2 0-0.3 0.1-0.4 0.3s-0.1 0.4-0.1 0.6c0.3 3.6 0.2 7.2-0.7 10.7-0.5 2.2-1.5 4.5-2.7 6.4-0.6 0.9-1.4 1.7-2 2.6s-1.5 1.6-2.3 2.3c-0.2 0.2-0.5 0.4-0.6 0.7s0 0.7 0.1 1.1c0.2 0.8 0.6 1.6 1.3 1.8 0.5 0.1 0.9-0.1 1.3-0.3 0.9-0.4 1.8-0.8 2.7-1.2 0.4-0.2 0.7-0.3 1.1-0.6 1.8-1 3.8-1.7 5.8-2.3 4.3-1.1 9-1.1 13.3 0.1 0.2 0.1 0.4 0.1 0.6 0.1 0.7-0.1 0.9-1 0.6-1.6-0.4-0.6-1-0.9-1.7-1.2-2.5-1.1-4.9-2.1-7.5-2.7-0.6-0.2-1.3-0.3-2-0.4-0.3-0.1-0.5 0-0.8-0.1s-0.9 0-1.1-0.1-0.3 0-0.3-0.2c0-0.4 0.7-0.7 1-0.8 0.5-0.3 1-0.7 1.5-1l5.4-3.6c0.4-0.2 0.6-0.6 1-0.9 1.2-0.9 2.8-1.3 4-2.2 0.4-0.3 0.9-0.6 1.3-0.9l2.7-1.8c1-0.6 2.2-1.2 3.2-1.8 0.9-0.5 1.9-0.8 2.7-1.6 0.9-0.8 2.2-1.4 3.2-2 1.2-0.7 2.3-1.4 3.5-2.1 4.1-2.5 8.2-4.9 12.7-6.6 5.2-1.9 10.6-3.4 16.2-4 5.4-0.6 10.8-0.3 16.2-0.5h0.5c1.4-0.1 2.3-0.1 1.7 1.7-1.4 4.5 1.3 7.5 4.3 10 3.4 2.9 7 5.7 11.3 7.1 4.8 1.6 9.6 3.8 14.9 2.7 3-0.6 6.5-4 6.8-6.4 0.2-1.7 0.1-3.3-0.3-4.9-0.4-1.4-1-3-2.2-3.9-0.9-0.6-1.6-1.6-2.4-2.4-0.9-0.8-1.9-1.7-2.9-2.3-2.1-1.4-4.2-2.6-6.5-3.5-3.2-1.3-6.6-2.2-10-3-0.8-0.2-1.6-0.4-2.5-0.5-0.2 0-1.3-0.1-1.3-0.3-0.1-0.2 0.3-0.4 0.5-0.6 0.9-0.8 1.8-1.5 2.7-2.2 1.9-1.4 3.8-2.8 5.8-3.9 2.1-1.2 4.3-2.3 6.6-3.2 1.2-0.4 2.3-0.8 3.6-1 0.6-0.2 1.2-0.2 1.8-0.4 0.4-0.1 0.7-0.3 1.1-0.5 1.2-0.5 2.7-0.5 3.9-0.8 1.3-0.2 2.7-0.4 4.1-0.7 2.7-0.4 5.5-0.8 8.2-1.1 3.3-0.4 6.7-0.7 10-1 7.7-0.6 15.3-0.3 23 1.3 4.2 0.9 8.3 1.9 12.3 3.6 1.2 0.5 2.3 1.1 3.5 1.5 0.7 0.2 1.3 0.7 1.8 1.1 0.7 0.6 1.5 1.1 2.3 1.7 0.2 0.2 0.6 0.3 0.8 0.2 0.1-0.1 0.1-0.2 0.2-0.4 0.1-0.9-0.2-1.7-0.7-2.4-0.4-0.6-1-1.4-1.6-1.9-0.8-0.7-2-1.1-2.9-1.6-1-0.5-2-0.9-3.1-1.3-2.5-1.1-5.2-2-7.8-2.8-1-0.8-2.4-1.2-3.7-1.4zm-64.4 25.8c4.7 1.3 10.3 3.3 14.6 7.9 0.9 1 2.4 1.8 1.8 3.5-0.6 1.6-2.2 1.5-3.6 1.7-4.9 0.8-9.4-1.2-13.6-2.9-4.5-1.7-8.8-4.3-11.9-8.3-0.5-0.6-1-1.4-1.1-2.2 0-0.3 0-0.6-0.1-0.9s-0.2-0.6 0.1-0.9c0.2-0.2 0.5-0.2 0.8-0.2 2.3-0.1 4.7 0 7.1 0.4 0.9 0.1 1.6 0.6 2.5 0.8 1.1 0.4 2.3 0.8 3.4 1.1z">
                </path>
              </svg>
            </figure>
            <!-- SVG decoration -->
            <figure class="position-absolute top-0 start-0 ms-n9">
              <svg width="22px" height="22px" viewBox="0 0 22 22">
                <polygon class="fill-orange"
                  points="22,8.3 13.7,8.3 13.7,0 8.3,0 8.3,8.3 0,8.3 0,13.7 8.3,13.7 8.3,22 13.7,22 13.7,13.7 22,13.7 ">
                </polygon>
              </svg>
            </figure>
            <!-- SVG decoration -->
            <figure class="position-absolute top-100 start-100 translate-middle ms-5 d-none d-lg-block">
              <svg width="21.5px" height="21.5px" viewBox="0 0 21.5 21.5">
                <polygon class="fill-danger"
                  points="21.5,14.3 14.4,9.9 18.9,2.8 14.3,0 9.9,7.1 2.8,2.6 0,7.2 7.1,11.6 2.6,18.7 7.2,21.5 11.6,14.4 18.7,18.9 ">
                </polygon>
              </svg>
            </figure>
            <!-- SVG decoration -->
            <figure class="position-absolute top-0 start-100 translate-middle d-none d-md-block">
              <svg width="27px" height="27px">
                <path class="fill-purple"
                  d="M13.122,5.946 L17.679,-0.001 L17.404,7.528 L24.661,5.946 L19.683,11.533 L26.244,15.056 L18.891,16.089 L21.686,23.068 L15.400,19.062 L13.122,26.232 L10.843,19.062 L4.557,23.068 L7.352,16.089 L-0.000,15.056 L6.561,11.533 L1.582,5.946 L8.839,7.528 L8.565,-0.001 L13.122,5.946 Z">
                </path>
              </svg>
            </figure>

            <!-- Title -->
            <h1>Education, talents, and career opportunities. All in one place.</h1>
            <p>Get inspired and discover something new today. Grow your skill with the most reliable online courses
              and
              certifications in marketing, information technology, programming, and data science. </p>

            <!-- Search course -->
            <div class="col-md-8 text-center mx-auto pb-5">
              <form class="bg-body shadow rounded p-2">
                <div class="input-group">
                  <input
                    class="form-control border-0 me-1"
                    type="search"
                    placeholder="Search for a course by title"
                    v-model="searchQuery"
                    @input="handleSearch"
                    @focus="showResults = true"
                    @blur="hideResultsDelayed"
                  >
                </div>
              </form>

              <!-- Search Results Dropdown -->
              <div v-if="showResults && filteredCourses.length > 0" class="search-results shadow rounded">
                <router-link :to="{ name: 'CourseView', params: { id: course.id } }" v-for="course in filteredCourses" :key="course.id" class="search-result-item">
                  <div class="search-result-image">
                    <img :src="getImageUrl(course.thumbnail)" alt="Course thumbnail">
                  </div>
                  <div class="search-result-info content-left">
                    <h6 class="content-left">{{ course.title }} ({{ course.category }})</h6>
                    <div class="course-price">
                      <span v-if="course.price === 0" class="current-price">Free</span>
                      <div v-if="course.discount > 0">
                        <span v-if="course.discount > 0" class="original-price">${{ course.price.toFixed(2) }}</span>
                        <span class="current-price">${{ getDiscountedPrice(course) }}</span>
                      </div>
                    </div>
                  </div>
                </router-link>
              </div>
            </div>
          </div>
        </div>
        <!-- Title and SVG END -->
      </div>
    </section>
    <!-- Main Banner END -->

    <!-- Video START -->
    <section class="pb-0 py-sm-0 mt-n8">
      <div class="container">
        <div class="row">
          <div class="col-md-8 text-center mx-auto">
            <div class="card card-body shadow p-2">
              <div class="position-relative">
                <!-- Image -->
                <img src="../../assets/website/images/about/12.jpg" class="card-img rounded-2" alt="...">
                <div class="card-img-overlay">
                  <!-- Video link -->
                  <div class="position-absolute top-50 start-50 translate-middle">
                    <a href="https://www.youtube.com/embed/tXHviS-4ygo"
                      class="btn btn-lg text-danger btn-round btn-white-shadow mb-0" data-glightbox=""
                      data-gallery="video-tour">
                      <i class="fas fa-play"></i>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- Video END -->

    <!-- Courses Start -->
    <section class="pt-0 pt-md-5">
      <div class="container">
        <!-- Title -->
        <div class="row">
          <div class="col-lg-8 mb-4">
            <h2 class="mb-0">Our <span class="text-warning">Trending</span> Courses</h2>
            <p class="mb-0">Check out most ðŸ”¥ courses in the market</p>
          </div>
        </div>

        <div v-if="loading" class="loading-container">
          <div class="loading-spinner"></div>
        </div>

        <div v-else-if="courses.length === 0" class="empty-state">
          <p>No courses found. Create your first course!</p>
        </div>

        <div v-else class="row g-4">
          <!-- Card START -->
          <div  v-for="course in courses" :key="course.id" class="col-md-6 col-xl-4">
            <div class="card shadow-hover overflow-hidden">
              <div class="position-relative">
                <!-- Image -->
                <img class="card-img-top" :src="getImageUrl(course.thumbnail)" alt="Card image">
                <!-- Overlay -->
                <div class="bg-overlay bg-dark opacity-4"></div>
                <div class="card-img-overlay d-flex align-items-start flex-column">
                  <!-- Card overlay bottom -->
                  <div class="w-100 mt-auto d-inline-flex">
                    <div class="d-flex align-items-center bg-white p-2 rounded-2">
                      <!-- Avatar -->
                      <div class="avatar avatar-sm me-2">
                        <img class="avatar-img rounded-1" src="../../assets/website/images/avatar/10.jpg" alt="avatar">
                      </div>
                      <!-- Avatar info -->
                      <div>
                        <h6 class="mb-0"><a href="#" class="text-dark">Larry Lawson</a></h6>
                        <span class="small">Tutor</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Card body -->
              <div class="card-body">
                <!-- Badge and icon -->
                <div class="d-flex justify-content-between mb-3">
                  <div class="stack">
                    <div class="badge bg-orange bg-opacity-10 text-orange">{{ course.level }}</div>
                    <div class="badge ml-2 bg-dark text-white">{{ course.category }}</div>
                  </div>
                  <div class="h6 fw-light mb-0"><i class="far fa-bookmark"></i></div>
                </div>
                <!-- Title -->
                <h5 class="card-title">
                  <router-link :to="{ name: 'CourseView', params: { id: course.id } }" class="stretched-link">{{ course.title }}</router-link>
                </h5>
                <!-- Rating -->
                <ul class="list-inline">
                  <li class="list-inline-item h6 fw-light mb-0">4.5</li>
                  <li class="list-inline-item me-0 small"><i class="fas fa-star text-warning"></i>
                  </li>
                  <li class="list-inline-item me-0 small"><i class="fas fa-star text-warning"></i>
                  </li>
                  <li class="list-inline-item me-0 small"><i class="fas fa-star text-warning"></i>
                  </li>
                  <li class="list-inline-item me-0 small"><i class="fas fa-star text-warning"></i>
                  </li>
                  <li class="list-inline-item me-0 small"><i class="fas fa-star-half-alt text-warning"></i></li>
                  <li class="list-inline-item ms-2 text-reset">(6,500)</li>
                </ul>
                <!-- Divider -->
                <hr>
                <!-- Time -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h4 class="text-success mb-0">
                    <span v-if="course.price === 0" class="current-price">Free</span>
                    <div v-if="course.discount > 0">
                      <span v-if="course.discount > 0" class="original-price">${{ course.price.toFixed(2) }}</span>
                      <span class="current-price">${{ getDiscountedPrice(course) }}</span>
                    </div>
                  </h4>
                  <!-- Link with a bigger black SVG icon -->
                  <router-link :to="{ name: 'CourseView', params: { id: course.id } }" class="text-decoration-none">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M14 3H21V10" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M10 14L21 3" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M21 14V21H3V3H10" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </router-link>
                </div>
              </div>
            </div>
          </div>
          <!-- Card END -->

        </div>

      </div>
    </section>
    <!-- Courses End -->
  </div>
</template>
<script>
import api from '@/api'

export default {
  name: 'CourseList',
  data() {
    return {
      courses: [],
      loading: true,
      error: null,
      searchQuery: '',
      showResults: false,
      filteredCourses: [],
      searchTimeout: null
    }
  },
  created() {
    this.fetchCourses()
  },
  methods: {
    async fetchCourses() {
      try {
        this.loading = true
        const response = await api.get('/get-courses')
        this.courses = response.data.data

        // Ensure boolean values are properly set and add hover state
        this.courses = this.courses.map(course => {
          return {
            ...course,
            publish: Boolean(course.publish),
            certificate: Boolean(course.certificate),
            hover: false
          }
        })

        this.loading = false
      } catch (error) {
        console.error('Error fetching courses:', error)
        this.error = 'Failed to load courses. Please try again.'
        this.loading = false
      }
    },
    async deleteCourse(id) {
      if (!confirm('Are you sure you want to delete this course? This action cannot be undone.')) {
        return
      }

      try {
        await api.delete(`/courses/${id}`)
        this.courses = this.courses.filter(course => course.id !== id)
      } catch (error) {
        console.error('Error deleting course:', error.response ? error.response.data : error)
        this.error = 'Failed to delete course. Please try again.'
      }
    },
    getImageUrl(path) {
      if (!path) return ''
      return `${api.defaults.baseURL.replace('/api', '')}/storage/${path}`
    },
    getDiscountedPrice(course) {
      // Check if discount exists and discount end date is valid
      const hasValidDiscount = course.discount > 0 &&
        (!course.discount_ends_at || new Date(course.discount_ends_at) > new Date())

      if (hasValidDiscount) {
        return (parseFloat(course.price) - parseFloat(course.discount)).toFixed(2)
      }
      return parseFloat(course.price).toFixed(2)
    },
    handleSearch() {
      // Clear any existing timeout
      if (this.searchTimeout) {
        clearTimeout(this.searchTimeout)
      }

      // Set a timeout to avoid too many filter operations while typing
      this.searchTimeout = setTimeout(() => {
        // Special case for "0<text" pattern
        if (this.searchQuery.startsWith('0<')) {
          const searchText = this.searchQuery.substring(2).toLowerCase()
          this.filteredCourses = this.courses.filter(course =>
            course.title.toLowerCase().includes(searchText)
          )
        } else if (this.searchQuery.length > 0) {
          // Normal search
          this.filteredCourses = this.courses.filter(course =>
            course.title.toLowerCase().includes(this.searchQuery.toLowerCase())
          )
        } else {
          this.filteredCourses = []
        }
      }, 300)
    },
    hideResultsDelayed() {
      // Delay hiding results to allow for clicks on the results
      setTimeout(() => {
        this.showResults = false
      }, 200)
    },
    goToCourse(courseId) {
      this.$router.push({ name: 'CourseView', params: { id: courseId } })
    }
  }
}
</script>
<style>
.section-bg {
  background-image: url('@/assets/website/images/bg/03.jpg');
  background-position: center;
  background-size: cover;
}
.course-price {
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
}
.original-price {
    text-decoration: line-through;
    color: #777777;
    margin-right: 1rem;
}
.current-price {
    font-weight: 600;
    color: #000000;
}

/* Loading and empty states */
.loading-container {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 200px;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid #f3f3f3;
  border-top: 3px solid #000000;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.empty-state {
  background-color: #f8f8f8;
  border-radius: 8px;
  padding: 3rem 2rem;
  text-align: center;
  color: #555555;
}

.stack {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-wrap: wrap;
  gap: 0.5rem;
}
/* Search results dropdown styling */
.search-results {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background-color: white;
  z-index: 1000;
  max-height: 300px;
  overflow-y: auto;
  border-radius: 0.5rem;
  margin-top: 0.5rem;
}

.search-result-item {
  display: flex;
  padding: 0.75rem;
  border-bottom: 1px solid #f0f0f0;
  cursor: pointer;
  transition: background-color 0.2s;
}

.search-result-item:hover {
  background-color: #f0f2f4;
}

.search-result-image {
  width: 100px;
  height: 60px;
  margin-right: 1rem;
  flex-shrink: 0;
}

.search-result-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 0.25rem;
}

.search-result-info {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.content-left {
  text-align: left;
}

h6 {
  padding: none;
  margin: none;
}

@keyframes spin {
  0% {
    transform: rotate(0deg);
  }

  100% {
    transform: rotate(360deg);
  }
}

@media (max-width: 768px) {
  .header-actions {
    flex-direction: column;
    align-items: flex-start;
    gap: 1rem;
  }

  .course-grid {
    grid-template-columns: 1fr;
  }

  .search-results {
    position: fixed;
    top: auto;
    left: 1rem;
    right: 1rem;
    width: calc(100% - 2rem);
  }
}
</style>
